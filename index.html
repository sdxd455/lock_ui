<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find My Lock</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: rgba(255,255,255,0.95); }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; height: 100vh; overflow: hidden; }
        #map { height: 100%; width: 100%; }
        .panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .card { background: var(--bg); backdrop-filter: blur(20px); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 700; color: #000; }
        .badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #eee; color: #888; }
        .badge.on { background: var(--success); color: #fff; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-box { background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px; text-align: center; }
        .label { font-size: 11px; color: #888; text-transform: uppercase; }
        .val { font-size: 18px; font-weight: 700; color: #000; }
        .bar-bg { height: 6px; background: #eee; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s, background 0.3s; }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 18px; font-size: 16px; font-weight: 600; cursor: pointer; }
        #log { font-size: 10px; color: #aaa; text-align: center; margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-dot { width: 18px; height: 18px; background: #007AFF; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 10px rgba(0,122,255,0.2); animation: pulse 2s infinite; }
        .lock-dot { width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,122,255,0.4); } 70% { box-shadow: 0 0 0 15px rgba(0,122,255,0); } }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <div class="card">
            <div class="header">
                <div class="title">My Lock</div>
                <div id="status" class="badge">Êú™ËøûÊé•</div>
            </div>
            <div class="info-grid">
                <div class="info-box">
                    <div class="label">Ë∑ùÁ¶ª</div>
                    <div id="distVal" class="val">--</div>
                </div>
                <div class="info-box">
                    <div class="label">Áä∂ÊÄÅ</div>
                    <div id="lockStatus" class="val">üîí</div>
                </div>
            </div>
            <div class="bar-bg"><div id="distBar" class="bar-fill"></div></div>
            <div id="log">Waiting...</div>
        </div>
        <button id="btnConnect" class="btn">üì° ËøûÊé• HC-08 (Ëá™Âä®ÊãºÊé•)</button>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([31.2304, 121.4737], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬©OSM' }).addTo(map);
        
        const UserIcon = L.divIcon({ className: 'c', html: '<div class="user-dot"></div>', iconSize: [24,24] });
        const LockIcon = L.divIcon({ className: 'c', html: '<div class="lock-dot">üî¥</div>', iconSize: [30,30] });
        
        let userMarker, lockMarker;
        
        // ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÊîπ 1ÔºöÊï∞ÊçÆÁºìÂ≠òÂå∫ ‚òÖ‚òÖ‚òÖ
        let dataBuffer = "";

        // NMEAËΩ¨ÂçÅËøõÂà∂
        function nmeaToDec(val) {
            if(!val) return null;
            let v = parseFloat(val); if(isNaN(v)) return null;
            return Math.floor(v/100) + (v%100)/60;
        }

        function processLine(str) {
            // Ëß£ÊûêÂÆåÊï¥ÁöÑ‰∏ÄË°åÊï∞ÊçÆ
            document.getElementById('log').innerText = "RX: " + str;
            
            const distM = str.match(/DIST:(\d+)/);
            const latM = str.match(/LAT:([\d\.]+)/);
            const lonM = str.match(/LON:([\d\.]+)/);
            const lockM = str.match(/\| (LOCKED|OPEN)/);

            if(distM) {
                let d = parseInt(distM[1]);
                document.getElementById('distVal').innerText = d + " mm";
                let w = (d/3000)*100; if(w>100) w=100;
                const bar = document.getElementById('distBar');
                bar.style.width = w + "%";
                bar.style.background = d<1500 ? "#34C759" : (d>3000 ? "#FF3B30" : "#007AFF");
            }

            if(lockM) {
                const isLocked = (lockM[1] === "LOCKED");
                const div = document.getElementById('lockStatus');
                div.innerText = isLocked ? "üîí" : "üîì";
                div.style.color = isLocked ? "#000" : "#34C759";
            }

            if(latM && lonM) {
                let lat = nmeaToDec(latM[1]);
                let lon = nmeaToDec(lonM[1]);
                if(lat && lon) {
                    if(!lockMarker) lockMarker = L.marker([lat, lon], {icon: LockIcon}).addTo(map);
                    else lockMarker.setLatLng([lat, lon]);
                    
                    // Ëá™Âä®Ë∑üÈöèÊúÄÊñ∞ÂùêÊ†á
                    // map.setView([lat, lon], 18); 
                }
            }
        }

        // ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÊîπ 2ÔºöÊï∞ÊçÆÊãºÊé•ÈÄªËæë ‚òÖ‚òÖ‚òÖ
        function handleData(event) {
            const str = new TextDecoder().decode(event.target.value);
            dataBuffer += str; // ÊääÊñ∞Êî∂Âà∞ÁöÑÁ¢éÁâáÊãºÊé•Âà∞ÁºìÂ≠òÂêéÈù¢

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊç¢Ë°åÁ¨¶ (ËØ¥Êòé‰∏ÄÊù°Êï∞ÊçÆÁªìÊùü‰∫Ü)
            let newlineIdx = dataBuffer.indexOf('\n');
            
            while (newlineIdx !== -1) {
                // ÊèêÂèñÂÆåÊï¥ÁöÑ‰∏ÄË°å
                const line = dataBuffer.substring(0, newlineIdx).trim();
                if (line.length > 0) {
                    processLine(line); // Â§ÑÁêÜËøô‰∏ÄË°å
                }
                
                // ÊääÂ§ÑÁêÜÂÆåÁöÑËøôË°åÂà†ÊéâÔºå‰øùÁïôÂâ©‰∏ãÁöÑÁ¢éÁâá
                dataBuffer = dataBuffer.substring(newlineIdx + 1);
                
                // ÁªßÁª≠Êâæ‰∏ã‰∏Ä‰∏™Êç¢Ë°åÁ¨¶
                newlineIdx = dataBuffer.indexOf('\n');
            }
        }

        const UUID_FFF0 = 0xFFF0;
        const UUID_FFE0 = 0xFFE0;

        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [UUID_FFF0, UUID_FFE0]
                });

                document.getElementById('status').innerText = "ËøûÊé•‰∏≠...";
                const server = await device.gatt.connect();
                
                let service, char;
                try { service = await server.getPrimaryService(UUID_FFF0); } 
                catch { try { service = await server.getPrimaryService(UUID_FFE0); } catch(e){} }

                if(!service) throw new Error("Êú™ÊâæÂà∞ÊúçÂä°");

                const characteristics = await service.getCharacteristics();
                for (const c of characteristics) {
                    if (c.properties.notify) { char = c; break; }
                }

                if(!char) throw new Error("Êú™ÊâæÂà∞ÁâπÂæÅÂÄº");

                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleData);

                document.getElementById('status').innerText = "Âú®Á∫ø";
                document.getElementById('status').classList.add('on');
                document.getElementById('btnConnect').style.display = "none";
                document.getElementById('log').innerText = "ËøûÊé•ÊàêÂäüÔºÅ";

                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "Â∑≤Êñ≠ÂºÄ";
                    document.getElementById('status').classList.remove('on');
                    document.getElementById('btnConnect').style.display = "block";
                    alert("ËìùÁâôÂ∑≤Êñ≠ÂºÄ");
                });

            } catch (e) {
                alert("Â§±Ë¥•: " + e.message);
                document.getElementById('status').innerText = "Â§±Ë¥•";
            }
        });
    </script>
</body>
</html>
