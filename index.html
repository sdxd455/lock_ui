<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find My Lock</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ï¼Œæ­¤å¤„çœç•¥ CSS ä»¥èŠ‚çœç©ºé—´ */
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --text-main: #1c1c1e; --text-sub: #8e8e93; --ios-bg: rgba(255, 255, 255, 0.9); }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; height: 100vh; width: 100vw; overflow: hidden; }
        #map { height: 100%; width: 100%; }
        .panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .card { pointer-events: auto; background: var(--ios-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 22px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 700; color: var(--text-main); }
        .badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #E5E5EA; color: var(--text-sub); }
        .badge.on { background: var(--success); color: #fff; }
        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .val { font-size: 24px; font-weight: 700; color: var(--text-main); }
        .btn { pointer-events: auto; width: 100%; padding: 16px; border: none; border-radius: 18px; background: var(--primary); color: #fff; font-size: 16px; font-weight: 600; }
        #log { font-size: 10px; color: #aaa; text-align: center; margin-top: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-dot { width: 16px; height: 16px; background: #007AFF; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 10px rgba(0,122,255,0.2); }
        .lock-dot { width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .park-dot { width: 30px; height: 30px; background: #5856D6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid #fff; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <div class="card">
            <div class="header">
                <div class="title">My Lock</div>
                <div id="status" class="badge">æœªè¿æ¥</div>
            </div>
            
            <div class="info-row">
                <div><div style="font-size:12px;color:#888">è·ç¦» (UWB)</div><div id="distVal" class="val">--</div></div>
                <div><div style="font-size:12px;color:#888">çŠ¶æ€</div><div id="lockText" style="font-size:18px;font-weight:bold">ğŸ”’</div></div>
            </div>
            
            <!-- GPS çŠ¶æ€æ  -->
            <div style="background:rgba(0,0,0,0.05); padding:10px; border-radius:12px; display:flex; align-items:center; gap:10px;">
                <div style="font-size:16px;">ğŸ›°ï¸</div>
                <div>
                    <div style="font-size:10px; color:#888; text-transform:uppercase;">Vehicle Location</div>
                    <div id="gpsStatus" style="font-size:14px; font-weight:600; color:#333;">ç­‰å¾…ä¿¡å·...</div>
                </div>
            </div>

            <!-- åœè½¦è®°å½• -->
            <div id="parkingArea" style="margin-top:15px; display:none;">
                <div style="font-size:10px; color:#5856D6; font-weight:bold;">ä¸Šæ¬¡åœè½¦äº <span id="parkTime">--:--</span></div>
            </div>

            <div id="log">Ready</div>
        </div>
        <button id="btnConnect" class="btn">ğŸ“¡ è¿æ¥è®¾å¤‡</button>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([31.2304, 121.4737], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â©OSM' }).addTo(map);

        const UserIcon = L.divIcon({ className: 'c', html: '<div class="user-dot"></div>', iconSize: [24,24] });
        const LockIcon = L.divIcon({ className: 'c', html: '<div class="lock-dot">ğŸ”´</div>', iconSize: [30,30] });
        const ParkIcon = L.divIcon({ className: 'c', html: '<div class="park-dot">P</div>', iconSize: [34,34] });
        
        let userMarker, lockMarker, parkMarker;
        let dataBuffer = "";

        // 1. æ¢å¤è®°å½•
        window.onload = () => {
            if(navigator.geolocation) navigator.geolocation.watchPosition(updateUserPos, null, {enableHighAccuracy:true});
            const lat = localStorage.getItem('p_lat'), lon = localStorage.getItem('p_lon'), t = localStorage.getItem('p_time');
            if(lat && lon) updateParking(parseFloat(lat), parseFloat(lon), t, false);
        };

        function updateUserPos(pos) {
            const ll = [pos.coords.latitude, pos.coords.longitude];
            if(!userMarker) {
                userMarker = L.marker(ll, {icon: UserIcon}).addTo(map);
                if(!parkMarker) map.setView(ll, 17);
            } else userMarker.setLatLng(ll);
        }

        function updateParking(lat, lon, time, center=true) {
            if(!parkMarker) parkMarker = L.marker([lat, lon], {icon: ParkIcon}).addTo(map).bindPopup("åœè½¦ç‚¹");
            else parkMarker.setLatLng([lat, lon]);
            localStorage.setItem('p_lat', lat); localStorage.setItem('p_lon', lon); localStorage.setItem('p_time', time);
            document.getElementById('parkingArea').style.display = 'block';
            document.getElementById('parkTime').innerText = time;
            if(center) map.setView([lat, lon], 18);
        }

        function nmeaToDec(val) {
            if(!val) return null;
            let v = parseFloat(val); if(isNaN(v)) return null;
            return Math.floor(v/100) + (v%100)/60;
        }

        function processLine(str) {
            document.getElementById('log').innerText = "RX: " + str;
            
            const distM = str.match(/DIST:(\d+)/);
            const latM = str.match(/LAT:([\d\.]+)/);
            const lonM = str.match(/LON:([\d\.]+)/);
            const lockM = str.match(/\| (LOCKED|OPEN)/);
            const searching = str.includes("Searching");

            // è·ç¦»
            if(distM) {
                let d = parseInt(distM[1]);
                document.getElementById('distVal').innerText = d + " mm";
            }

            // é”çŠ¶æ€
            let isLocked = true;
            if(lockM) {
                isLocked = (lockM[1] === "LOCKED");
                const div = document.getElementById('lockText');
                div.innerText = isLocked ? "å·²å…³é”" : "å·²å¼€é”";
                div.style.color = isLocked ? "#1c1c1e" : "#34C759";
            }

            // â˜…â˜…â˜… GPS çŠ¶æ€é€»è¾‘ä¼˜åŒ– â˜…â˜…â˜…
            if (searching) {
                document.getElementById('gpsStatus').innerText = "ğŸ“¡ å«æ˜Ÿä¿¡å·æœå¯»ä¸­...";
                document.getElementById('gpsStatus').style.color = "#FF9500"; // æ©™è‰²
            } else if(latM && lonM) {
                let lat = nmeaToDec(latM[1]);
                let lon = nmeaToDec(lonM[1]);
                if(lat && lon) {
                    document.getElementById('gpsStatus').innerText = "ğŸ“ å·²å®šä½ (æ›´æ–°ä¸­)";
                    document.getElementById('gpsStatus').style.color = "#34C759"; // ç»¿è‰²
                    
                    if(!lockMarker) lockMarker = L.marker([lat, lon], {icon: LockIcon}).addTo(map);
                    else lockMarker.setLatLng([lat, lon]);

                    if(isLocked && lockM) {
                        const now = new Date();
                        const t = `${now.getHours()}:${(now.getMinutes()<10?'0':'')+now.getMinutes()}`;
                        updateParking(lat, lon, t, false);
                    }
                }
            }
        }

        function handleData(event) {
            const str = new TextDecoder().decode(event.target.value);
            dataBuffer += str;
            let idx = dataBuffer.indexOf('\n');
            while (idx !== -1) {
                const line = dataBuffer.substring(0, idx).trim();
                if (line.length > 0) processLine(line);
                dataBuffer = dataBuffer.substring(idx + 1);
                idx = dataBuffer.indexOf('\n');
            }
        }

        const UUID_FFF0 = 0xFFF0;
        const UUID_FFE0 = 0xFFE0;

        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [UUID_FFF0, UUID_FFE0]
                });
                
                const server = await device.gatt.connect();
                let service;
                try { service = await server.getPrimaryService(UUID_FFF0); } 
                catch { try { service = await server.getPrimaryService(UUID_FFE0); } catch(e){} }
                
                const characteristics = await service.getCharacteristics();
                let char = null;
                for (const c of characteristics) { if (c.properties.notify) { char = c; break; } }
                
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('status').innerText = "åœ¨çº¿";
                document.getElementById('status').classList.add('on');
                document.getElementById('btnConnect').style.display = "none";

                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "å·²æ–­å¼€";
                    document.getElementById('status').classList.remove('on');
                    document.getElementById('btnConnect').style.display = "block";
                    alert("è“ç‰™å·²æ–­å¼€");
                });

            } catch (e) {
                alert("è¿æ¥å¤±è´¥: " + e.message);
            }
        });
        
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                const ll = [p.coords.latitude, p.coords.longitude];
                if(!userMarker) userMarker = L.marker(ll, {icon: L.divIcon({className:'c', html:'<div class="user-dot"></div>', iconSize:[20,20]})}).addTo(map);
                else userMarker.setLatLng(ll);
            }, null, {enableHighAccuracy:true});
        }
    </script>
</body>
</html>
