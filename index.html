<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find My Lock (FFF0ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f2f2f7; height: 100vh; display: flex; flex-direction: column; }
        #map { flex: 1; width: 100%; }
        .panel { background: white; padding: 20px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 999; }
        .btn { width: 100%; padding: 15px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; margin-top: 10px; }
        .info { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        #log { font-size: 10px; color: #999; height: 20px; overflow: hidden; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <div class="info">
            <span>è·ç¦»: <span id="dist">--</span></span>
            <span>çŠ¶æ€: <span id="lock">--</span></span>
        </div>
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
        <button id="btn" class="btn">ğŸ“¡ è¿æ¥ HC-08 (FFF0)</button>
    </div>

    <script>
        const map = L.map('map').setView([31.2304, 121.4737], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let lockMarker = null;

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šé€‚é…ä½ çš„æ¨¡å—æˆªå›¾ â˜…â˜…â˜…
        // æœåŠ¡ UUID: 0000FFF0... -> ç®€å†™ä¸º 0xFFF0
        // ç‰¹å¾ UUID: é€šå¸¸æ˜¯ FFF1 ç”¨äºè¯»å†™
        const SERVICE_UUID = 0xFFF0;
        const CHAR_UUID = 0xFFF1; 

        function log(msg) { document.getElementById('log').innerText = msg; }

        function handleData(event) {
            const str = new TextDecoder().decode(event.target.value);
            log("æ”¶åˆ°: " + str);
            
            const distM = str.match(/DIST:(\d+)/);
            const latM = str.match(/LAT:([\d\.]+)/);
            const lonM = str.match(/LON:([\d\.]+)/);
            const lockM = str.match(/\| (LOCKED|OPEN)/);

            if (distM) document.getElementById('dist').innerText = distM[1] + " mm";
            if (lockM) document.getElementById('lock').innerText = lockM[1];

            if (latM && lonM) {
                // ç®€å•çš„æ ¼å¼è½¬æ¢
                let lat = parseFloat(latM[1]);
                let lon = parseFloat(lonM[1]);
                // ç²—ç•¥ä¿®æ­£ NMEA ddmm.mmmm -> dd.dddd (å¦‚æœä¸å‡†å¯ä»¥æš‚ç”¨åŸå§‹å€¼è°ƒè¯•)
                lat = Math.floor(lat/100) + (lat%100)/60;
                lon = Math.floor(lon/100) + (lon%100)/60;

                const pos = [lat, lon];
                if (!lockMarker) {
                    lockMarker = L.marker(pos).addTo(map).bindPopup("æ™ºèƒ½é”");
                    map.setView(pos, 18);
                } else {
                    lockMarker.setLatLng(pos);
                }
            }
        }

        document.getElementById('btn').addEventListener('click', async () => {
            try {
                log("æ­£åœ¨æœç´¢...");
                const device = await navigator.bluetooth.requestDevice({
                    // å¿…é¡»æŠŠ FFF0 æ”¾å…¥ filters æˆ– optionalServicesï¼Œå¦åˆ™å®‰å“ä¸è®©è¿
                    filters: [{ services: [SERVICE_UUID] }] 
                });

                log("è¿æ¥ GATT...");
                const server = await device.gatt.connect();
                
                log("è·å–æœåŠ¡ FFF0...");
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                log("è·å–ç‰¹å¾ FFF1...");
                const char = await service.getCharacteristic(CHAR_UUID);
                
                log("å¼€å¯é€šçŸ¥...");
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleData);

                log("âœ… è¿æ¥æˆåŠŸï¼ç­‰å¾…æ•°æ®...");
                document.getElementById('btn').style.display = 'none';

                device.addEventListener('gattserverdisconnected', () => {
                    log("âŒ å·²æ–­å¼€");
                    document.getElementById('btn').style.display = 'block';
                    alert("è“ç‰™æ–­å¼€");
                });

            } catch (e) {
                console.error(e);
                log("é”™è¯¯: " + e.message);
                alert("è¿æ¥å¤±è´¥: " + e.message + "\nè¯·ç¡®ä¿å·²åœ¨ç³»ç»Ÿè®¾ç½®ä¸­[å–æ¶ˆé…å¯¹]ï¼");
            }
        });
    </script>
</body>
</html>
