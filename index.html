<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find My Lock</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --text: #1c1c1e; --bg: rgba(255,255,255,0.9); }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #000; height: 100vh; overflow: hidden; }
        #map { height: 100%; width: 100%; }
        .panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .card { pointer-events: auto; background: var(--bg); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .val { font-size: 24px; font-weight: 700; color: var(--text); }
        .btn { pointer-events: auto; width: 100%; padding: 15px; border: none; border-radius: 15px; background: var(--primary); color: #fff; font-size: 16px; font-weight: bold; }
        .bar-bg { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .bar-fill { height: 100%; width: 0%; background: var(--primary); transition: 0.3s; }
        
        .user-dot { width: 18px; height: 18px; background: #007AFF; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 10px rgba(0,122,255,0.2); animation: pulse 2s infinite; }
        .lock-dot { width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .park-dot { width: 34px; height: 34px; background: #5856D6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid #fff; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,122,255,0.4); } 70% { box-shadow: 0 0 0 15px rgba(0,122,255,0); } }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <div class="card">
            <div class="row">
                <span style="font-size:20px;font-weight:bold">My Lock</span>
                <span id="status" style="font-size:12px;background:#eee;padding:4px 8px;border-radius:10px">Êú™ËøûÊé•</span>
            </div>
            <div class="row">
                <div><div style="font-size:10px;color:#888">Ë∑ùÁ¶ª</div><div id="distVal" class="val">--</div></div>
                <div><div style="font-size:10px;color:#888">Áä∂ÊÄÅ</div><div id="lockText" class="val">üîí</div></div>
            </div>
            <div class="bar-bg"><div id="distBar" class="bar-fill"></div></div>
            <div id="parkingInfo" style="margin-top:15px;display:none;font-size:12px;color:#5856D6;font-weight:bold;">üÖøÔ∏è ÂÅúËΩ¶‰ΩçÁΩÆÂ∑≤‰øùÂ≠ò</div>
            <div id="log" style="font-size:10px;color:#ccc;margin-top:10px;text-align:center;white-space:nowrap;overflow:hidden;">Ready</div>
        </div>
        <button id="btnConnect" class="btn">ËøûÊé•ËÆæÂ§á (Universal)</button>
    </div>

    <script>
        const map = L.map('map', {zoomControl: false}).setView([31.23, 121.47], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution:'¬©OSM'}).addTo(map);

        const I = {
            user: L.divIcon({className:'c', html:'<div class="user-dot"></div>', iconSize:[24,24]}),
            lock: L.divIcon({className:'c', html:'<div class="lock-dot">üî¥</div>', iconSize:[30,30]}),
            park: L.divIcon({className:'c', html:'<div class="park-dot">P</div>', iconSize:[34,34]})
        };
        let mUser, mLock, mPark, buf = "";

        // 1. Áî®Êà∑ÂÆö‰Ωç
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                const ll = [p.coords.latitude, p.coords.longitude];
                if(!mUser) { mUser = L.marker(ll, {icon:I.user}).addTo(map); if(!localStorage.getItem('pl')) map.setView(ll, 17); }
                else mUser.setLatLng(ll);
            }, null, {enableHighAccuracy:true});
        }
        
        // 2. ÂÅúËΩ¶ÊÅ¢Â§ç
        window.onload = () => {
            const l=localStorage.getItem('pl'), n=localStorage.getItem('pn'), t=localStorage.getItem('pt');
            if(l && n) updatePark(parseFloat(l), parseFloat(n), t, false);
        };

        function updatePark(lat, lon, time, center=true) {
            if(!mPark) mPark = L.marker([lat,lon], {icon:I.park}).addTo(map);
            else mPark.setLatLng([lat,lon]);
            localStorage.setItem('pl', lat); localStorage.setItem('pn', lon); localStorage.setItem('pt', time);
            document.getElementById('parkingInfo').style.display = 'block';
            if(center) map.setView([lat,lon], 18);
        }

        // 3. Êï∞ÊçÆÂ§ÑÁêÜ
        function proc(s) {
            document.getElementById('log').innerText = s;
            const dist = s.match(/DIST:(\d+)/), lat = s.match(/LAT:([\d\.]+)/), lon = s.match(/LON:([\d\.]+)/), lock = s.match(/\| (LOCKED|OPEN)/);

            if(dist) {
                let d = parseInt(dist[1]);
                document.getElementById('distVal').innerText = d + " mm";
                let w = (d/3000)*100; if(w>100) w=100;
                const b = document.getElementById('distBar');
                b.style.width = w+"%"; b.style.background = d<1500?"#34C759":"#007AFF";
            }

            let isLocked = true;
            if(lock) {
                isLocked = (lock[1] === "LOCKED");
                const t = document.getElementById('lockText');
                t.innerText = isLocked ? "üîí" : "üîì"; t.style.color = isLocked ? "#1c1c1e" : "#34C759";
            }

            if(lat && lon) {
                let la = parseFloat(lat[1]), lo = parseFloat(lon[1]);
                // ÁÆÄÊòìËΩ¨Êç¢
                la = Math.floor(la/100) + (la%100)/60;
                lo = Math.floor(lo/100) + (lo%100)/60;
                
                if(!mLock) mLock = L.marker([la,lo], {icon:I.lock}).addTo(map);
                else mLock.setLatLng([la,lo]);

                if(isLocked && lock) {
                    const now = new Date();
                    updatePark(la, lo, `${now.getHours()}:${now.getMinutes()}`, false);
                }
            }
        }

        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                // HC-08(FFF0) Âíå HC-02(FFE0) ÂÖºÂÆπ
                const dev = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0xFFF0, 0xFFE0]
                });

                document.getElementById('status').innerText = "ËøûÊé•‰∏≠...";
                const srv = await dev.gatt.connect();
                
                let svc, char;
                try { svc = await srv.getPrimaryService(0xFFF0); } catch { svc = await srv.getPrimaryService(0xFFE0); }
                const chars = await svc.getCharacteristics();
                for(let c of chars) { if(c.properties.notify) { char = c; break; } }
                
                if(!char) throw "Êó†Êï∞ÊçÆÈÄöÈÅì";
                
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', e => {
                    buf += new TextDecoder().decode(e.target.value);
                    let i = buf.indexOf('\n');
                    while(i !== -1) {
                        proc(buf.substring(0, i).trim());
                        buf = buf.substring(i+1);
                        i = buf.indexOf('\n');
                    }
                });

                document.getElementById('status').innerText = "Âú®Á∫ø";
                document.getElementById('status').classList.add('on');
                document.getElementById('btnConnect').style.display = 'none';

            } catch(e) { alert("Â§±Ë¥•: "+e.message); }
        });
    </script>
</body>
</html>
