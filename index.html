<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find My Lock</title>
    
    <!-- Leaflet åœ°å›¾åº“ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --ios-blur: saturate(180%) blur(20px);
            --ios-bg: rgba(255, 255, 255, 0.85);
            --ios-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            --primary-color: #007AFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --parking-color: #5856D6;
        }

        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background: #000; overflow: hidden; height: 100vh; }
        #map { height: 100%; width: 100%; z-index: 0; }

        /* åº•éƒ¨é¢æ¿ */
        .panel-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px; z-index: 1000;
            display: flex; flex-direction: column; gap: 12px;
        }

        .card {
            background: var(--ios-bg); backdrop-filter: var(--ios-blur); -webkit-backdrop-filter: var(--ios-blur);
            border-radius: 24px; box-shadow: var(--ios-shadow); padding: 20px;
            border: 1px solid rgba(255,255,255,0.4);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 700; color: #000; }
        .badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #E5E5EA; color: #8E8E93; transition: 0.3s; }
        .badge.on { background: var(--success-color); color: #fff; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .box { background: rgba(255,255,255,0.6); border-radius: 16px; padding: 12px; text-align: center; }
        .label { font-size: 11px; color: #8E8E93; text-transform: uppercase; margin-bottom: 4px; }
        .val { font-size: 18px; font-weight: 700; color: #000; font-variant-numeric: tabular-nums; }
        
        .bar-bg { height: 6px; background: #E5E5EA; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--primary-color); transition: width 0.3s, background 0.3s; }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 18px;
            background: var(--primary-color); color: #fff; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }

        /* åœè½¦ä¿¡æ¯ */
        .parking-info {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .parking-text { font-size: 12px; color: #333; }
        .parking-time { font-size: 10px; color: #8E8E93; }

        /* åœ°å›¾å›¾æ ‡ */
        .user-dot { width: 18px; height: 18px; background: #007AFF; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 10px rgba(0,122,255,0.2); animation: pulse 2s infinite; }
        .lock-dot { width: 24px; height: 24px; background: #FF3B30; border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; box-shadow: 0 4px 10px rgba(255,59,48,0.4); }
        .park-icon { width: 30px; height: 30px; background: var(--parking-color); border: 2px solid #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; box-shadow: 0 4px 10px rgba(88, 86, 214, 0.4); }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,122,255,0.4); } 70% { box-shadow: 0 0 0 15px rgba(0,122,255,0); } 100% { box-shadow: 0 0 0 0 rgba(0,122,255,0); } }
        
        /* è°ƒè¯•æ—¥å¿— */
        #debugInfo { font-size:10px; color:#bbb; margin-top:10px; text-align:center; height:12px; overflow:hidden; white-space: nowrap; text-overflow: ellipsis;}
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="panel-container">
        <div class="card">
            <div class="header">
                <div class="title">My Lock</div>
                <div id="status" class="badge">æœªè¿æ¥</div>
            </div>

            <div class="grid">
                <div class="box">
                    <div class="label">è·ç¦» (Distance)</div>
                    <div id="valDist" class="val">--</div>
                </div>
                <div class="box">
                    <div class="label">çŠ¶æ€ (Status)</div>
                    <div id="iconLock" style="font-size: 22px;">ğŸ”’</div>
                </div>
            </div>

            <div class="bar-bg"> <div id="distBar" class="bar-fill"></div> </div>
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#999; margin-top:6px;">
                <span>0m</span><span>1.5m</span><span>3.0m</span>
            </div>
            
            <!-- åœè½¦ä½ç½®è®°å½• -->
            <div class="parking-info" id="parkingInfoArea" style="opacity: 0.5;">
                <div>
                    <div style="font-weight: 600; font-size: 14px; color: var(--parking-color);">ğŸ…¿ï¸ è½¦è¾†ä½ç½®</div>
                    <div id="lastSeenTime" class="parking-time">æš‚æ— è®°å½•</div>
                </div>
                <div id="lastCoords" class="parking-text">--</div>
            </div>

            <div id="debugInfo">ç­‰å¾…è¿æ¥...</div>
        </div>

        <button id="btnConnect" class="btn">ğŸ“¡ è¿æ¥è®¾å¤‡ (UUID: FFF0)</button>
    </div>

    <script>
        // --- 1. åœ°å›¾åˆå§‹åŒ– ---
        const map = L.map('map', { zoomControl: false }).setView([31.2304, 121.4737], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â©OpenStreetMap' }).addTo(map);

        const UserIcon = L.divIcon({ className: 'custom-icon', html: '<div class="user-dot"></div>', iconSize: [24, 24], iconAnchor: [12, 12] });
        const LockIcon = L.divIcon({ className: 'custom-icon', html: '<div class="lock-dot">ğŸ”´</div>', iconSize: [30, 30], iconAnchor: [15, 30] });
        const ParkingIcon = L.divIcon({ className: 'custom-icon', html: '<div class="park-icon">P</div>', iconSize: [34, 34], iconAnchor: [17, 34] });

        let userMarker = null;
        let lockMarker = null;
        let parkingMarker = null;

        // --- 2. å­˜å‚¨ä¸æ¢å¤ ---
        window.onload = function() {
            startUserTracking();
            const savedLat = localStorage.getItem('park_lat');
            const savedLon = localStorage.getItem('park_lon');
            const savedTime = localStorage.getItem('park_time');

            if (savedLat && savedLon) {
                updateParkingLocation(parseFloat(savedLat), parseFloat(savedLon), savedTime, false);
            }
        };

        function startUserTracking() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    if (!userMarker) {
                        userMarker = L.marker([lat, lng], {icon: UserIcon}).addTo(map);
                        if(!localStorage.getItem('park_lat')) map.setView([lat, lng], 17);
                    } else {
                        userMarker.setLatLng([lat, lng]);
                    }
                }, null, { enableHighAccuracy: true });
            }
        }

        // --- 3. è“ç‰™é€»è¾‘ (é€‚é…ä½ çš„ HC-08) ---
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®ä½ çš„æˆªå›¾ï¼ŒUUID æ˜¯ FFF0 â˜…â˜…â˜…
        const SERVICE_UUID = 0xFFF0;
        const CHAR_UUID = 0xFFF1; // FFF0 æœåŠ¡ä¸‹é€šå¸¸æ­é… FFF1 ç‰¹å¾å€¼

        function nmeaToDec(valStr) {
            if (!valStr) return null;
            let val = parseFloat(valStr);
            if (isNaN(val)) return null;
            let deg = Math.floor(val / 100);
            let min = val % 100;
            return deg + (min / 60);
        }

        function updateParkingLocation(lat, lon, timeStr, autoCenter = true) {
            if (!parkingMarker) {
                parkingMarker = L.marker([lat, lon], {icon: ParkingIcon}).addTo(map).bindPopup("è½¦è¾†æœ€åä½ç½®");
            } else {
                parkingMarker.setLatLng([lat, lon]);
            }
            localStorage.setItem('park_lat', lat);
            localStorage.setItem('park_lon', lon);
            localStorage.setItem('park_time', timeStr);

            document.getElementById('parkingInfoArea').style.opacity = "1";
            document.getElementById('lastSeenTime').innerText = "æ›´æ–°äº: " + timeStr;
            document.getElementById('lastCoords').innerText = lat.toFixed(5) + ", " + lon.toFixed(5);
            if(autoCenter) map.setView([lat, lon], 18);
        }

        function handleData(event) {
            const str = new TextDecoder().decode(event.target.value);
            document.getElementById('debugInfo').innerText = "RX: " + str.trim();

            const distM = str.match(/DIST:(\d+)/);
            const latM = str.match(/LAT:([\d\.]+)/);
            const lonM = str.match(/LON:([\d\.]+)/);
            const lockM = str.match(/\| (LOCKED|OPEN)/);

            if (distM) {
                let d = parseInt(distM[1]);
                document.getElementById('valDist').innerText = d + " mm";
                let pct = (d/3000)*100; if(pct>100) pct=100;
                const bar = document.getElementById('distBar');
                bar.style.width = pct + "%";
                bar.style.background = d < 1500 ? "#34C759" : "#007AFF";
            }

            if (lockM) {
                const isLocked = lockM[1] === "LOCKED";
                document.getElementById('iconLock').innerText = isLocked ? "ğŸ”’" : "ğŸ”“";
                document.getElementById('iconLock').style.color = isLocked ? "#000" : "#34C759";
            }

            if (latM && lonM && lockM) {
                let lat = nmeaToDec(latM[1]);
                let lon = nmeaToDec(lonM[1]);
                const isLocked = lockM[1] === "LOCKED";

                if (lat && lon) {
                    if (!lockMarker) lockMarker = L.marker([lat, lon], {icon: LockIcon}).addTo(map);
                    else lockMarker.setLatLng([lat, lon]);

                    if (isLocked) {
                        const now = new Date();
                        const timeStr = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
                        updateParkingLocation(lat, lon, timeStr, false);
                    }
                }
            }
        }

       document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) {
                    alert('è¯·ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨');
                    return;
                }

                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹å› filters æ¨¡å¼ï¼ŒæŒ‡å®š UUID â˜…â˜…â˜…
                // è¿™æ ·å¯ä»¥å‘Šè¯‰ Windows æˆ‘ä»¬åªéœ€è¦è¿™ä¸ªæœåŠ¡ï¼Œä¸éœ€è¦å®Œæ•´é…å¯¹
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ 
                        services: [0xFFF0] // å¿…é¡»æ˜¯æ•´æ•°æ ¼å¼æˆ–å­—ç¬¦ä¸²æ ¼å¼ "0000fff0-0000-1000-8000-00805f9b34fb"
                    }],
                    optionalServices: [0xFFF0] // å†æ¬¡ç”³æ˜
                });

                document.getElementById('status').innerText = "è¿æ¥ä¸­...";
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0xFFF0); // æ³¨æ„è¿™é‡Œä¹Ÿè¦æ”¹
                
                // å°è¯•è·å–ç‰¹å¾å€¼ (FFF1)
                const char = await service.getCharacteristic(0xFFF1);
                
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleData);

                document.getElementById('status').innerText = "åœ¨çº¿";
                document.getElementById('status').classList.add('on');
                document.getElementById('btnConnect').style.display = "none";

                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "å·²æ–­å¼€";
                    document.getElementById('status').classList.remove('on');
                    document.getElementById('btnConnect').style.display = "block";
                    alert("è“ç‰™å·²æ–­å¼€");
                });

            } catch (e) {
                console.error(e);
                // è¿™é‡Œçš„æç¤ºä¼šæ›´å…·ä½“
                alert("è¿æ¥å¤±è´¥: " + e.message + "\nå»ºè®®ï¼šè¯·é‡å¯ç”µè„‘è“ç‰™å¼€å…³å†è¯•ï¼");
                document.getElementById('status').innerText = "å¤±è´¥";
            }
        });
    </script>
</body>
</html>
