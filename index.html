<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find My Lock (iOS Fix)</title>
    <style>
        body { font-family: -apple-system, monospace; background: #000; color: #fff; padding: 20px; }
        button { width: 100%; padding: 20px; font-size: 18px; background: #007AFF; color: white; border: none; border-radius: 12px; margin-bottom: 20px; }
        #console { background: #1c1c1e; padding: 15px; border-radius: 12px; height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; border: 1px solid #333; }
        .log-step { color: #64D2FF; }
        .log-ok { color: #30D158; }
        .log-err { color: #FF453A; font-weight: bold; border-left: 3px solid #FF453A; padding-left: 10px; }
        .log-data { color: #FFD60A; }
    </style>
</head>
<body>
    <h1>iOS 专用连接</h1>
    <button id="btn">点击连接设备</button>
    <div id="console">准备就绪...</div>

    <script>
        function log(msg, type='') {
            const box = document.getElementById('console');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            div.className = 'log-' + type;
            div.innerText = `[${time}] ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ★★★ 核心修改：使用完整的 128位 UUID 字符串 (小写) ★★★
        // 只有这样写，Bluefy 才能正确识别！
        const UUID_SEARCH       = "0000fff0-0000-1000-8000-00805f9b34fb"; // 搜索用
        const UUID_DATA_SERVICE = "0000ffe0-0000-1000-8000-00805f9b34fb"; // 数据服务
        // const UUID_DATA_CHAR    = "0000ffe1-0000-1000-8000-00805f9b34fb"; // 特征值

        document.getElementById('btn').addEventListener('click', async () => {
            try {
                log("--- 开始流程 (iOS Fix) ---");
                
                if (!navigator.bluetooth) throw "浏览器不支持蓝牙 (请确认使用Bluefy)";

                // 1. 搜索设备
                log(`正在搜索...`, "step");
                
                const device = await navigator.bluetooth.requestDevice({
                    // 必须使用完整字符串 UUID
                    filters: [{ services: [UUID_SEARCH] }],
                    optionalServices: [UUID_DATA_SERVICE, UUID_SEARCH] 
                });

                log(`已选设备: ${device.name}`, "ok");
                
                // 2. 连接 GATT
                log("正在连接...", "step");
                const server = await device.gatt.connect();
                log("GATT 连接成功", "ok");

                // 3. 获取服务 (优先找 FFE0)
                log("获取服务...", "step");
                let service;
                try {
                    service = await server.getPrimaryService(UUID_DATA_SERVICE);
                    log("找到数据服务 FFE0", "ok");
                } catch(e) {
                    log("未找到 FFE0，尝试 FFF0...", "step");
                    service = await server.getPrimaryService(UUID_SEARCH);
                    log("找到服务 FFF0", "ok");
                }

                // 4. 自动扫描特征值 (全兼容)
                log("扫描特征值...", "step");
                const characteristics = await service.getCharacteristics();
                
                let targetChar = null;
                for (const c of characteristics) {
                    log(`发现特征: ${c.uuid.substring(0,8)}...`, "step");
                    if (c.properties.notify) {
                        targetChar = c;
                        break;
                    }
                }

                if(!targetChar) throw "未找到支持 Notify 的特征值";
                
                log(`选中特征: ${targetChar.uuid.substring(0,8)}...`, "ok");

                // 5. 开启通知
                await targetChar.startNotifications();
                log("✅ 监听已开启！等待数据...", "ok");
                
                targetChar.addEventListener('characteristicvaluechanged', (event) => {
                    const str = new TextDecoder().decode(event.target.value);
                    log(`RX: ${str.trim()}`, "data");
                });

                device.addEventListener('gattserverdisconnected', () => {
                    log("❌ 蓝牙已断开", "err");
                    alert("断开连接");
                });

            } catch (error) {
                // 增强版错误捕获，防止显示 undefined
                let msg = error;
                if (typeof error === 'object') {
                    msg = error.message || JSON.stringify(error);
                }
                log(`错误: ${msg}`, "err");
            }
        });
    </script>
</body>
</html>
