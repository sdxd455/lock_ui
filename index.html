<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find My Lock</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ä¿æŒä¹‹å‰çš„ iOS æ ·å¼ï¼Œæ­¤å¤„çœç•¥ CSS ä»¥èŠ‚çœç¯‡å¹…ï¼Œç›´æ¥å¥—ç”¨ä¹‹å‰çš„å³å¯ */
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --text-main: #1c1c1e; --text-sub: #8e8e93; --ios-bg: rgba(255, 255, 255, 0.9); }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; height: 100vh; width: 100vw; overflow: hidden; }
        #map { height: 100%; width: 100%; }
        .panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .card { pointer-events: auto; background: var(--ios-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 22px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 700; color: var(--text-main); }
        .badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #E5E5EA; color: var(--text-sub); }
        .badge.on { background: var(--success); color: #fff; }
        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .val { font-size: 24px; font-weight: 700; color: var(--text-main); }
        .btn { pointer-events: auto; width: 100%; padding: 16px; border: none; border-radius: 18px; background: var(--primary); color: #fff; font-size: 16px; font-weight: 600; }
        #log { font-size: 10px; color: #aaa; text-align: center; margin-top: 10px; }
        .user-dot { width: 16px; height: 16px; background: #007AFF; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 10px rgba(0,122,255,0.2); }
        .lock-dot { width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <div class="card">
            <div class="header">
                <div class="title">My Lock</div>
                <div id="status" class="badge">æœªè¿æ¥</div>
            </div>
            <div class="info-row">
                <div><div style="font-size:12px;color:#888">DISTANCE</div><div id="distVal" class="val">--</div></div>
                <div><div style="font-size:12px;color:#888">STATUS</div><div id="lockText" style="font-size:18px;font-weight:bold">ğŸ”’</div></div>
            </div>
            <div id="log">Ready</div>
        </div>
        <button id="btnConnect" class="btn">è¿æ¥è®¾å¤‡</button>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([31.2304, 121.4737], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â©OSM' }).addTo(map);
        let userMarker, lockMarker;

        // ç®€æ˜“åæ ‡è½¬æ¢
        function nmeaToDec(val) {
            if (!val) return null;
            let v = parseFloat(val); if (isNaN(v)) return null;
            return Math.floor(v/100) + (v%100)/60;
        }

        // å¤„ç†é€»è¾‘
        function updateUI(str) {
            // ä¸å†ç­‰å¾…æ¢è¡Œç¬¦ï¼Œåªè¦åŒ¹é…åˆ°å…³é”®ä¿¡æ¯å°±æ›´æ–°
            const distM = str.match(/DIST:(\d+)/);
            const latM = str.match(/LAT:([\d\.]+)/);
            const lonM = str.match(/LON:([\d\.]+)/);
            const lockM = str.match(/\| (LOCKED|OPEN)/);

            if (distM) {
                document.getElementById('distVal').innerText = distM[1] + " mm";
                document.getElementById('log').innerText = "æ›´æ–°äº: " + new Date().toLocaleTimeString();
            }

            if (lockM) {
                const isLocked = lockM[1] === "LOCKED";
                document.getElementById('lockText').innerText = isLocked ? "å·²å…³é” ğŸ”’" : "å·²å¼€é” ğŸ”“";
                document.getElementById('lockText').style.color = isLocked ? "#1c1c1e" : "#34C759";
            }

            if (latM && lonM) {
                let lat = nmeaToDec(latM[1]);
                let lon = nmeaToDec(lonM[1]);
                if (lat && lon) {
                    const pos = [lat, lon];
                    if (!lockMarker) {
                        lockMarker = L.marker(pos, {
                            icon: L.divIcon({className:'c', html:'<div class="lock-dot">ğŸš²</div>', iconSize:[30,30]})
                        }).addTo(map);
                        map.setView(pos, 18);
                    } else {
                        lockMarker.setLatLng(pos);
                    }
                }
            }
        }

        let rawBuffer = "";
        
        function handleData(event) {
            const chunk = new TextDecoder().decode(event.target.value);
            rawBuffer += chunk;
            
            // â˜…â˜…â˜… å®¹é”™é€»è¾‘ï¼šåªè¦ buffer é‡ŒåŒ…å«äº†å®Œæ•´çš„ä¿¡æ¯æ®µï¼Œå°±å°è¯•è§£æ â˜…â˜…â˜…
            // æ¯”å¦‚åªè¦åŒ…å« "LOCKED" æˆ–è€… "\n" å°±è§£æä¸€æ¬¡
            if (rawBuffer.includes("\n") || rawBuffer.length > 50) {
                updateUI(rawBuffer);
                // ç®€å•çš„æ¸…ç†ç­–ç•¥ï¼šä¿ç•™æœ€å20ä¸ªå­—ç¬¦é˜²æ­¢æˆªæ–­ï¼Œæˆ–è€…æ¸…ç©º
                // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬æ‰¾åˆ°æœ€åä¸€ä¸ªæ¢è¡Œç¬¦æ¸…ç©º
                let lastIdx = rawBuffer.lastIndexOf('\n');
                if (lastIdx !== -1) {
                    rawBuffer = rawBuffer.substring(lastIdx + 1);
                } else {
                    rawBuffer = ""; // å¤ªé•¿äº†è¿˜æ²¡æ¢è¡Œï¼Œç›´æ¥æ¸…ç©ºé˜²æº¢å‡º
                }
            }
        }

        // UUID è®¾ç½®
        const UUID_SEARCH = "0000fff0-0000-1000-8000-00805f9b34fb";
        const UUID_DATA   = "0000ffe0-0000-1000-8000-00805f9b34fb";

        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [UUID_SEARCH] }],
                    optionalServices: [UUID_DATA, UUID_SEARCH]
                });
                
                const server = await device.gatt.connect();
                let service;
                try { service = await server.getPrimaryService(UUID_DATA); } catch { try { service = await server.getPrimaryService(UUID_SEARCH); } catch(e){} }
                
                const characteristics = await service.getCharacteristics();
                let char = null;
                for (const c of characteristics) { if (c.properties.notify) { char = c; break; } }
                
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('status').innerText = "åœ¨çº¿";
                document.getElementById('status').classList.add('on');
                document.getElementById('btnConnect').style.display = "none";

            } catch (e) {
                alert("è¿æ¥å¤±è´¥: " + e.message);
            }
        });
        
        // å¯åŠ¨ç”¨æˆ·å®šä½
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                const ll = [p.coords.latitude, p.coords.longitude];
                if(!userMarker) userMarker = L.marker(ll, {icon: L.divIcon({className:'c', html:'<div class="user-dot"></div>', iconSize:[20,20]})}).addTo(map);
                else userMarker.setLatLng(ll);
            }, null, {enableHighAccuracy:true});
        }
    </script>
</body>
</html>
