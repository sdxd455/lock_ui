<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find My Lock (Diagnostic)</title>
    <style>
        body { font-family: monospace; background: #222; color: #fff; padding: 20px; }
        button { width: 100%; padding: 20px; font-size: 18px; background: #007AFF; color: white; border: none; border-radius: 10px; margin-bottom: 20px; }
        #console { background: #000; padding: 10px; border: 1px solid #444; height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; }
        .log-step { color: #0ff; }
        .log-ok { color: #0f0; }
        .log-err { color: #f55; font-weight: bold; border: 1px solid #f55; padding: 5px; margin: 5px 0; }
        .log-data { color: #ff0; }
    </style>
</head>
<body>
    <h1>故障诊断模式</h1>
    <button id="btn">点击开始诊断连接</button>
    <div id="console">等待操作...</div>

    <script>
        function log(msg, type='') {
            const box = document.getElementById('console');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.className = 'log-' + type;
            div.innerText = `[${time}] ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // 根据你提供的模块信息：
        // 搜索 UUID: FFF0
        // 数据 UUID: FFE0 -> FFE1
        const UUID_SEARCH = 0xFFF0;
        const UUID_DATA_SERVICE = 0xFFE0;
        const UUID_DATA_CHAR = 0xFFE1;

        document.getElementById('btn').addEventListener('click', async () => {
            try {
                log("--- 开始流程 ---");
                
                // 1. 环境检查
                if (!navigator.bluetooth) throw new Error("浏览器不支持 Web Bluetooth");
                log("浏览器环境: OK", "ok");

                // 2. 搜索设备
                log(`正在搜索服务: 0x${UUID_SEARCH.toString(16)}`, "step");
                
                // 这里我们显式声明所有可能用到的服务，防止“有权限连接没权限读数据”
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [UUID_SEARCH] }],
                    optionalServices: [UUID_DATA_SERVICE, UUID_SEARCH] 
                });

                log(`已选设备: ${device.name} (ID: ${device.id})`, "ok");
                
                // 3. 连接 GATT
                log("正在连接 GATT Server...", "step");
                const server = await device.gatt.connect();
                
                if(!server.connected) throw new Error("GATT 连接虽然返回了但状态仍为断开");
                log("GATT 连接成功", "ok");

                // 4. 获取服务
                log(`正在获取数据服务: 0x${UUID_DATA_SERVICE.toString(16)}...`, "step");
                let service;
                try {
                    service = await server.getPrimaryService(UUID_DATA_SERVICE);
                    log("成功获取到 FFE0 服务", "ok");
                } catch(e) {
                    log("获取 FFE0 失败，尝试获取 FFF0...", "step");
                    service = await server.getPrimaryService(UUID_SEARCH);
                    log("成功获取到 FFF0 服务", "ok");
                }

                if(!service) throw new Error("未找到任何可用服务 (FFE0/FFF0)");

                // 5. 获取特征值
                log("正在获取特征值...", "step");
                const characteristics = await service.getCharacteristics();
                
                let targetChar = null;
                log(`发现 ${characteristics.length} 个特征值:`);
                
                for (const c of characteristics) {
                    const props = [];
                    if(c.properties.read) props.push("Read");
                    if(c.properties.write) props.push("Write");
                    if(c.properties.notify) props.push("Notify");
                    if(c.properties.indicate) props.push("Indicate");
                    
                    log(` - ${c.uuid} [${props.join(',')}]`);
                    
                    // 优先找 FFE1，或者任何支持 Notify 的
                    if ((c.uuid.indexOf("ffe1") !== -1 || c.uuid.indexOf("fff1") !== -1) && c.properties.notify) {
                        targetChar = c;
                    } else if (!targetChar && c.properties.notify) {
                        targetChar = c; // 备选
                    }
                }

                if(!targetChar) throw new Error("没有找到支持 Notify (通知) 的特征值");
                
                log(`选中特征值: ${targetChar.uuid}`, "ok");

                // 6. 开启通知
                log("正在开启通知流...", "step");
                await targetChar.startNotifications();
                log("通知已开启！等待数据...", "ok");
                
                targetChar.addEventListener('characteristicvaluechanged', (event) => {
                    const str = new TextDecoder().decode(event.target.value);
                    log(`收到数据: ${str}`, "data");
                });

                device.addEventListener('gattserverdisconnected', () => {
                    log("!!! 蓝牙意外断开 !!!", "err");
                    alert("蓝牙断开");
                });

            } catch (e) {
                console.error(e);
                log(`❌ 发生错误:\n${e.name}: ${e.message}`, "err");
                alert("错误: " + e.message);
            }
        });
    </script>
</body>
</html>
