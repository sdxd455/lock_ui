<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find My Lock (Debug)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; }
        body { margin: 0; padding: 0; font-family: monospace; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        #map { height: 40vh; width: 100%; border-bottom: 1px solid #ccc; }
        
        .panel { flex: 1; padding: 15px; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status { font-size: 12px; padding: 4px 8px; background: #eee; border-radius: 4px; }
        .status.on { background: #34C759; color: #fff; }

        /* è°ƒè¯•æ—¥å¿—çª—å£ */
        .console-box { 
            flex: 1; background: #1e1e1e; color: #0f0; 
            padding: 10px; border-radius: 8px; overflow-y: auto; 
            font-size: 11px; line-height: 1.4; border: 1px solid #333;
            margin-bottom: 10px;
        }
        .log-time { color: #888; margin-right: 5px; }
        .log-rx { color: #0f0; }      /* ç»¿è‰²ï¼šæ¥æ”¶æ•°æ® */
        .log-info { color: #0ff; }    /* é’è‰²ï¼šç³»ç»Ÿä¿¡æ¯ */
        .log-err { color: #f55; }     /* çº¢è‰²ï¼šé”™è¯¯ */

        .data-display { display: flex; gap: 10px; margin-bottom: 10px; }
        .box { flex: 1; background: #f9f9f9; padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .box span { display: block; color: #888; font-size: 10px; }
        .box strong { font-size: 16px; color: #333; }

        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel">
        <div class="header">
            <strong>è°ƒè¯•æ§åˆ¶å°</strong>
            <span id="status" class="status">æœªè¿æ¥</span>
        </div>

        <div class="data-display">
            <div class="box"><span>è·ç¦»</span><strong id="valDist">--</strong></div>
            <div class="box"><span>çŠ¶æ€</span><strong id="valLock">--</strong></div>
        </div>

        <div id="console" class="console-box">
            <div>ç­‰å¾…è¿æ¥... è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®</div>
        </div>

        <button id="btnConnect" class="btn">ğŸ“¡ å…¨é€šé“è¿æ¥</button>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([31.2304, 121.4737], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â©OSM' }).addTo(map);
        let lockMarker = L.marker([31.2304, 121.4737]).addTo(map).bindPopup("é”ä½ç½®");

        // æ—¥å¿—åŠŸèƒ½
        function log(msg, type='info') {
            const box = document.getElementById('console');
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            line.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${msg}</span>`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        }

        // æ•°æ®ç¼“å­˜åŒº
        let dataBuffer = "";

        // NMEAè§£æ
        function nmeaToDec(val) {
            if(!val) return null;
            let v = parseFloat(val); if(isNaN(v)) return null;
            return Math.floor(v/100) + (v%100)/60;
        }

        // å¤„ç†å®Œæ•´çš„ä¸€è¡Œæ•°æ®
        function processLine(str) {
            log(str, 'rx'); // â˜…â˜…â˜… åœ¨å±å¹•ä¸Šç›´æ¥æ‰“å°æ”¶åˆ°çš„åŸå§‹æ•°æ® â˜…â˜…â˜…

            // å®½æ¾æ­£åˆ™åŒ¹é… (å¿½ç•¥å¤§å°å†™ï¼Œå…è®¸ç©ºæ ¼)
            const distM = str.match(/DIST\s*:\s*(\d+)/i);
            const latM = str.match(/LAT\s*:\s*([\d\.]+)/i);
            const lonM = str.match(/LON\s*:\s*([\d\.]+)/i);
            const lockM = str.match(/\|\s*(LOCKED|OPEN)/i);

            if(distM) document.getElementById('valDist').innerText = distM[1] + " mm";
            if(lockM) document.getElementById('valLock').innerText = lockM[1];

            if(latM && lonM) {
                let lat = nmeaToDec(latM[1]);
                let lon = nmeaToDec(lonM[1]);
                if(lat && lon) {
                    lockMarker.setLatLng([lat, lon]);
                    map.setView([lat, lon]);
                    log(`åœ°å›¾æ›´æ–°: ${lat.toFixed(5)}, ${lon.toFixed(5)}`, 'info');
                }
            }
        }

        // æ¥æ”¶æ•°æ®æµ
        function handleData(event) {
            const str = new TextDecoder().decode(event.target.value);
            dataBuffer += str;
            let idx = dataBuffer.indexOf('\n');
            while (idx !== -1) {
                const line = dataBuffer.substring(0, idx).trim();
                if (line.length > 0) processLine(line);
                dataBuffer = dataBuffer.substring(idx + 1);
                idx = dataBuffer.indexOf('\n');
            }
        }

        const UUID_SERVICE = 0xFFF0; 

        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) return alert("è¯·ä½¿ç”¨ Chrome/Edge æˆ– Bluefy");

                log("æ­£åœ¨æœç´¢ FFF0 è®¾å¤‡...", 'info');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [UUID_SERVICE] }]
                });

                log(`è¿æ¥ GATT... (${device.name})`, 'info');
                const server = await device.gatt.connect();
                
                log("è·å–æœåŠ¡ FFF0...", 'info');
                const service = await server.getPrimaryService(UUID_SERVICE);

                log("æ‰«ææ‰€æœ‰ç‰¹å¾å€¼...", 'info');
                const characteristics = await service.getCharacteristics();

                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæµ·ç‹æ¨¡å¼ï¼Œè®¢é˜…æ‰€æœ‰æ”¯æŒ Notify çš„ç‰¹å¾å€¼ â˜…â˜…â˜…
                let successCount = 0;
                for (const char of characteristics) {
                    const props = char.properties;
                    log(`å‘ç°ç‰¹å¾: ${char.uuid.substring(4,8)} (Notify:${props.notify})`, 'info');
                    
                    if (props.notify) {
                        try {
                            await char.startNotifications();
                            char.addEventListener('characteristicvaluechanged', handleData);
                            log(`âœ… å·²è®¢é˜…: ${char.uuid.substring(4,8)}`, 'info');
                            successCount++;
                        } catch (err) {
                            log(`âŒ è®¢é˜…å¤±è´¥ ${char.uuid}: ${err.message}`, 'err');
                        }
                    }
                }

                if (successCount === 0) throw new Error("æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯è®¢é˜…çš„ç‰¹å¾å€¼ï¼");

                document.getElementById('status').innerText = "å·²è¿æ¥";
                document.getElementById('status').classList.add('on');
                document.getElementById('btnConnect').style.display = "none";
                
                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "å·²æ–­å¼€";
                    document.getElementById('status').classList.remove('on');
                    document.getElementById('btnConnect').style.display = "block";
                    log("è“ç‰™å·²æ–­å¼€", 'err');
                });

            } catch (e) {
                console.error(e);
                log("è¿æ¥å¤±è´¥: " + e.message, 'err');
                alert("é”™è¯¯: " + e.message);
            }
        });
    </script>
</body>
</html>
